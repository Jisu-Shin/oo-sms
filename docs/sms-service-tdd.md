# SMS Service TDD 구현

## 1. **SRS(소프트웨어 요구사항 명세서) 작성**
✅ **완료** - `docs/sms-service-SRS.md` 참조 (실제 코드 기반 완전 분석)

## 2. **SRS를 잘 설명할 수 있는 예시 목록 작성**

### SMS 발송 기능
- **정상적인 SMS 발송**
  - 예시: 고객 리스트[고객ID:1, 전화번호:"01012345678"], 발송일시:"202509061400", 템플릿ID:1
  - 기대 결과: true 반환, SMS 객체들이 생성되어 저장됨

- **빈 고객 리스트로 발송 시도**
  - 예시: 고객 리스트[], 발송일시:"202509061400", 템플릿ID:1
  - 기대 결과: IllegalArgumentException("sms 발송할 고객이 없습니다.")

- **빈 전화번호로 발송 시도**
  - 예시: 고객 리스트[고객ID:1, 전화번호:""], 발송일시:"202509061400", 템플릿ID:1
  - 기대 결과: IllegalArgumentException("고객의 전화번호가 비어있습니다")

- **존재하지 않는 템플릿으로 발송 시도**
  - 예시: 고객 리스트[정상], 발송일시:"202509061400", 템플릿ID:999
  - 기대 결과: IllegalArgumentException("해당 SMS 템플릿이 없습니다: 999")

### SMS 목록 조회 기능
- **기간별 SMS 목록 조회**
  - 예시: 시작일시:"202509060900", 종료일시:"202509061800"
  - 기대 결과: 해당 기간에 발송된 SMS 리스트 반환

- **잘못된 날짜 형식으로 조회**
  - 예시: 시작일시:"20250906" (HHmm 누락), 종료일시:"202509061800"
  - 기대 결과: DateTimeParseException 발생

### SMS 템플릿 생성 기능
- **변수가 있는 템플릿 생성**
  - 예시: 템플릿 내용:"안녕하세요 #{고객명}님, #{공연명} 공연 예매가 완료되었습니다.", SMS유형:"INFORMAITONAL"
  - 기대 결과: 템플릿 생성 후 ID 반환, #{고객명}, #{공연명} 변수와 관계 설정

- **변수가 없는 템플릿 생성**
  - 예시: 템플릿 내용:"일반 안내 메시지입니다.", SMS유형:"INFORMAITONAL"
  - 기대 결과: 템플릿 생성 후 ID 반환, 변수 관계는 없음

- **존재하지 않는 변수를 포함한 템플릿 생성**
  - 예시: 템플릿 내용:"안녕하세요 #{존재하지않는변수}님", SMS유형:"INFORMAITONAL"
  - 기대 결과: IllegalArgumentException("해당 템플릿 변수는 없습니다 : 존재하지않는변수")

### SMS 템플릿 수정 기능
- **기존 템플릿 내용 및 변수 관계 수정**
  - 예시: 템플릿ID:1, 새 내용:"수정된 #{고객명}님 메시지", SMS유형:"ADVERTISING"
  - 기대 결과: 템플릿 업데이트, 기존 변수 관계 삭제 후 새 관계 생성

- **존재하지 않는 템플릿 수정 시도**
  - 예시: 템플릿ID:999, 새 내용:"수정된 메시지", SMS유형:"INFORMAITONAL"
  - 기대 결과: IllegalArgumentException("해당 템플릿은 없습니다 : 999")

### SMS 템플릿 삭제 기능
- **템플릿 및 관련 관계 삭제**
  - 예시: 템플릿ID:1
  - 기대 결과: 템플릿-변수 관계 먼저 삭제, 그 다음 템플릿 삭제

- **존재하지 않는 템플릿 삭제 시도**
  - 예시: 템플릿ID:999
  - 기대 결과: IllegalArgumentException("해당 템플릿은 없습니다 : 999")

### SMS Factory 기능
- **SMS 객체 리스트 생성**
  - 예시: SMS템플릿, 고객 리스트[2명], 발송 요청 정보
  - 기대 결과: 2개의 SMS 객체 생성, 각각 변수 바인딩 완료, 필터링 결과 설정

- **날짜 파싱 및 SMS 객체 생성**
  - 예시: 발송일시 "202509061400" → LocalDateTime 변환
  - 기대 결과: 정확한 LocalDateTime으로 변환되어 SMS 객체에 설정

### SMS 필터링 기능
- **인증 문자는 모든 필터 통과**
  - 예시: SMS유형:VERIFICATION, 시간:야간, 고객동의:ALL_DENY
  - 기대 결과: SmsResult.SUCCESS

- **시간 필터링 (운영환경)**
  - 예시: 발송시간:새벽 6시, Profile:prod
  - 기대 결과: SmsResult.NOT_SEND_TIME

- **고객 동의 필터링**
  - 예시: SMS유형:ADVERTISING, 고객동의:ADVERTISE_DENY
  - 기대 결과: SmsResult.CUST_REJECT

- **광고 횟수 제한 필터링**
  - 예시: 고객ID:1, 오늘 광고성 SMS 2건 이미 발송, 추가 광고성 SMS 발송 시도
  - 기대 결과: SmsResult.AD_COUNT_OVER

### 템플릿 변수 바인딩 기능
- **고객 변수 바인딩**
  - 예시: 템플릿:"안녕하세요 #{고객명}님", 고객ID:1, 고객명:"홍길동"
  - 기대 결과: "안녕하세요 홍길동님"

- **공연 변수 바인딩**
  - 예시: 템플릿:"#{공연명} 예매 완료 (가격: #{공연가격}원)", 공연ID:100
  - 기대 결과: "오페라의 유령 예매 완료 (가격: 50000원)"

- **복합 변수 바인딩**
  - 예시: 템플릿:"#{고객명}님, #{공연명} 공연이 #{공연가격}원에 예매되었습니다."
  - 기대 결과: "홍길동님, 오페라의 유령 공연이 50000원에 예매되었습니다."

- **존재하지 않는 변수 바인딩 시도**
  - 예시: 고객 바인더에서 "#{존재하지않는변수}" 처리 시도
  - 기대 결과: IllegalStateException("템플릿 변수 치환값이 없습니다: 존재하지않는변수")

### 외부 서비스 연동 기능
- **고객 서비스 연동 성공**
  - 예시: 고객ID:1 조회
  - 기대 결과: CustListResponseDto 반환

- **고객 서비스 연동 실패**
  - 예시: 고객 서비스 장애 시 호출
  - 기대 결과: IllegalStateException 발생

- **공연 서비스 연동 성공**
  - 예시: 공연ID:100 조회
  - 기대 결과: ItemGetResponseDto 반환

### 템플릿 변수 유틸리티 기능
- **변수 추출**
  - 예시: "안녕하세요 #{고객명}님, #{공연명} 예매 완료"
  - 기대 결과: ["고객명", "공연명"] 리스트 반환

- **변수 치환**
  - 예시: 템플릿 + 치환 맵 {"고객명": "홍길동", "공연명": "오페라"}
  - 기대 결과: "안녕하세요 홍길동님, 오페라 예매 완료"

### 템플릿 변수 관리 기능
- **템플릿 변수 생성**
  - 예시: enText:"custGrade", koText:"고객등급", variableType:"고객"
  - 기대 결과: 템플릿 변수 ID 반환

- **템플릿 변수 전체 조회**
  - 예시: 등록된 모든 템플릿 변수 조회
  - 기대 결과: TemplateVariableDto 리스트 반환

## 3. **테스트 케이스 목록 작성**

### SmsService 단위 테스트
- [x] **TC-001**: SMS 발송 성공 테스트
- [x] **TC-002**: 빈 고객 리스트로 발송 시 예외 발생
- [x] **TC-003**: 빈 전화번호로 발송 시 예외 발생  
- [x] **TC-004**: 존재하지 않는 템플릿 ID로 발송 시 예외 발생
- [x] **TC-005**: 기간별 SMS 목록 조회 성공
- [x] **TC-006**: 잘못된 날짜 형식으로 조회 시 예외 발생

### SmsTemplateService 단위 테스트
- [x] **TC-007**: 변수가 있는 템플릿 생성 성공 테스트
- [x] **TC-008**: 변수가 없는 템플릿 생성 성공 테스트
- [x] **TC-009**: 존재하지 않는 템플릿 변수 사용 시 예외 발생
- [x] **TC-010**: 템플릿 수정 성공 테스트
- [x] **TC-011**: 템플릿 수정 시 기존 관계 삭제 후 새 관계 생성 검증
- [x] **TC-012**: 존재하지 않는 템플릿 수정 시 예외 발생
- [x] **TC-013**: 템플릿 삭제 성공 테스트
- [x] **TC-014**: 존재하지 않는 템플릿 삭제 시 예외 발생
- [x] **TC-015**: 템플릿 전체 목록 조회 테스트

### TemplateVariableService 단위 테스트
- [x] **TC-016**: 템플릿 변수 생성 성공 테스트
- [x] **TC-017**: 템플릿 변수 전체 목록 조회 테스트

### SmsFactory 단위 테스트
- [x] **TC-018**: SMS 리스트 생성 성공 테스트
- [x] **TC-019**: 날짜 파싱 및 SMS 객체 생성 검증
- [x] **TC-020**: 의존성 호출 순서 검증 (바인딩 → 필터링 → 결과 설정)
- [x] **TC-021**: 빈 고객 리스트 처리

### SMS 필터링 단위 테스트
- [x] **TC-022**: 인증 문자는 모든 필터 통과 테스트
- [x] **TC-023**: 시간 필터링 - 발송 불가 시간 테스트 (운영환경)
- [x] **TC-024**: 시간 필터링 - 발송 가능 시간 테스트 (운영환경)
- [x] **TC-025**: 고객 동의 필터링 - ALL_ALLOW 테스트
- [x] **TC-026**: 고객 동의 필터링 - ALL_DENY 테스트
- [x] **TC-027**: 고객 동의 필터링 - ADVERTISE_DENY 테스트
- [x] **TC-028**: 광고 횟수 제한 필터링 - 제한 초과 테스트
- [x] **TC-029**: 광고 횟수 제한 필터링 - 제한 미초과 테스트

### 템플릿 변수 바인딩 단위 테스트
- [x] **TC-030**: 변수가 없는 템플릿 바인딩 테스트
- [x] **TC-031**: 고객 변수 바인딩 성공 테스트
- [x] **TC-032**: 공연 변수 바인딩 성공 테스트
- [x] **TC-033**: 복합 변수 바인딩 테스트 (고객+공연)
- [x] **TC-034**: 존재하지 않는 고객 변수 바인딩 시 예외 발생
- [x] **TC-035**: 존재하지 않는 공연 변수 바인딩 시 예외 발생
- [x] **TC-036**: 변수 유형별 그룹핑 처리 테스트

### 외부 서비스 연동 단위 테스트
- [x] **TC-037**: 고객 서비스 연동 성공 테스트
- [x] **TC-038**: 고객 서비스 연동 실패 시 예외 발생 테스트
- [x] **TC-039**: 공연 서비스 연동 성공 테스트

### 유틸리티 클래스 단위 테스트
- [x] **TC-040**: 템플릿에서 변수 추출 성공 테스트
- [x] **TC-041**: 변수가 없는 템플릿에서 추출 시 빈 리스트 반환
- [x] **TC-042**: 템플릿 변수 치환 성공 테스트
- [x] **TC-043**: 치환할 변수가 없을 때 원본 반환 테스트

### 도메인 엔티티 단위 테스트
- [ ] **TC-044**: SmsTemplate 생성 메서드 테스트
- [ ] **TC-045**: SmsTemplate 변수 관계 추가 테스트
- [ ] **TC-046**: SmsTemplate 업데이트 메서드 테스트
- [ ] **TC-047**: SmsTemplate 관계 삭제 테스트
- [ ] **TC-048**: Sms 빌더 패턴 테스트
- [ ] **TC-049**: TemplateVariable 생성 메서드 테스트
- [ ] **TC-050**: SmsTmpltVarRel 생성 메서드 테스트

### Repository 단위 테스트
- [ ] **TC-051**: SMS 기간별 조회 쿼리 테스트
- [ ] **TC-052**: 광고성 SMS 오늘 발송 개수 조회 테스트
- [ ] **TC-053**: 템플릿-변수 관계 삭제 쿼리 테스트
- [ ] **TC-054**: QueryDSL 복잡 조회 쿼리 테스트

### API 컨트롤러 단위 테스트
- [x] **TC-055**: SMS API 컨트롤러 테스트
- [ ] **TC-056**: SMS 템플릿 API 컨트롤러 테스트
- [ ] **TC-057**: 템플릿 변수 API 컨트롤러 테스트

### 통합 테스트
- [ ] **TC-058**: SMS 발송 전체 플로우 통합 테스트
- [ ] **TC-059**: SMS 템플릿 CRUD 전체 플로우 통합 테스트
- [ ] **TC-060**: 외부 서비스 연동 통합 테스트
- [ ] **TC-061**: 대량 SMS 발송 성능 테스트
- [ ] **TC-062**: 필터링 규칙 통합 테스트
- [ ] **TC-063**: 변수 바인딩 통합 테스트

### 환경별 테스트
- [ ] **TC-064**: 운영환경 시간 필터 테스트 (@Profile("prod"))
- [ ] **TC-065**: 개발환경 시간 필터 테스트 (기본 프로필)

## 4. **주요 개선사항 및 누락된 기능**

### 4.1 누락된 API 기능
- **SMS 템플릿 수정 API**: PUT /api/smsTemplates/{id}
- **SMS 템플릿 삭제 API**: DELETE /api/smsTemplates/{id}

### 4.2 개선된 기능 분석
- **템플릿 변수 패턴**: `{변수}` → `#{변수}` 형태로 구현됨
- **변수 유형별 바인딩**: TemplateVariableType과 VariableBinder의 Map 기반 동적 처리
- **외부 서비스 연동**: 고객 서비스(cust-service), 공연 서비스(booking-service)
- **환경별 필터링**: @Profile을 활용한 운영/개발 환경 구분
- **광고 SMS 제한**: DB 기반 실시간 발송 횟수 체크
- **고객 동의 정책**: Map 기반 OCP 준수 설계

### 4.3 아키텍처 개선사항
- **QueryDSL 적용**: 복잡한 조회 쿼리 처리
- **MapStruct 매퍼**: DTO 변환 자동화
- **Stream API**: 함수형 프로그래밍 적용
- **컴포지트 패턴**: SmsFilter 체인 처리
- **전략 패턴**: VariableBinder 구현체들
- **팩토리 패턴**: SmsFactory를 통한 객체 생성

## 5. **테스트 구현 상태**

### 5.1 완료된 테스트
- SmsService 기본 기능 테스트
- SmsTemplateService 기본 기능 테스트
- TemplateVariableService 기본 기능 테스트
- SmsFactory 기본 기능 테스트
- SMS 필터링 로직 테스트
- 템플릿 변수 바인딩 테스트
- 외부 서비스 연동 테스트
- 유틸리티 클래스 테스트
- API 컨트롤러 기본 테스트

### 5.2 추가 구현 필요 테스트
- 도메인 엔티티 생성/수정 메서드 테스트
- Repository 계층 쿼리 테스트
- API 컨트롤러 완전성 테스트
- 통합 테스트 및 성능 테스트
- 환경별 설정 테스트

### 5.3 테스트 커버리지 목표
- **단위 테스트**: 각 클래스별 90% 이상
- **통합 테스트**: 주요 비즈니스 플로우 100% 커버
- **API 테스트**: 모든 엔드포인트 테스트

---

**문서 버전**: 3.0  
**작성일**: 2025년 9월 24일  
**기반 코드**: sms-service 모듈 실제 구현체 완전 분석